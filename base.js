window.selection={material:null,texture:null};let materialsConfig=null;const textureCache={},MATERIAL_NAME="ceiling";let isScreenLocked=!1,lockedPosition=null,lockedRotation=null;function createPickerUI(){const e=document.createElement("div");e.id="picker",e.className="collapsed",e.style.position="absolute",e.style.top="30%",e.style.left="20px",e.style.zIndex="1000";const t=document.createElement("button");t.id="toggle-picker",t.textContent="→";const o=document.createElement("div");o.id="picker-content";const n=document.createElement("h3");n.textContent="Textures";const i=document.createElement("div");i.className="texture-container",i.id="texture-container",o.appendChild(n),o.appendChild(i),e.appendChild(t),e.appendChild(o),document.body.appendChild(e),t.addEventListener("click",(function(){e.classList.toggle("collapsed"),e.classList.contains("collapsed")?this.textContent="→":this.textContent="←"}))}function createLockButton(){const e=document.createElement("div");e.id="lock-container",e.style.position="absolute",e.style.top="50%",e.style.right="20px",e.style.transform="translateY(-50%)",e.style.zIndex="1000";const t=document.createElement("button");t.id="lock-button",t.className="lock-button",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>',t.addEventListener("click",toggleScreenLock),e.appendChild(t),document.body.appendChild(e)}function lockScreen(){const e=WALK.getViewer();if(e)try{const t=e.getCameraPosition(),o=e.getCameraRotation();lockedPosition={x:t.x,y:t.y,z:t.z},lockedRotation={yaw:o.yaw,pitch:o.pitch,roll:o.roll},setupMovementBlocker(),document.addEventListener("keydown",blockNavigationKeys),window._lockInterval&&clearInterval(window._lockInterval),window._lockInterval=setInterval((()=>{const t=e.getCameraPosition(),o=e.getCameraRotation(),n=Math.abs(t.x-lockedPosition.x)>.001||Math.abs(t.y-lockedPosition.y)>.001||Math.abs(t.z-lockedPosition.z)>.001||Math.abs(o.yaw-lockedRotation.yaw)>.001||Math.abs(o.pitch-lockedRotation.pitch)>.001;n&&window._isAllowedTransition?(lockedPosition={x:t.x,y:t.y,z:t.z},lockedRotation={yaw:o.yaw,pitch:o.pitch,roll:o.roll},window._isAllowedTransition=!1):n&&!window._isAllowedTransition&&("function"==typeof e.setCameraPosition&&e.setCameraPosition(lockedPosition.x,lockedPosition.y,lockedPosition.z),"function"==typeof e.setCameraRotation&&e.setCameraRotation(lockedRotation.yaw,lockedRotation.pitch,lockedRotation.roll))}),50);const n=document.getElementById("lock-button");n&&n.classList.add("locked");document.querySelectorAll(".view-menu a, [data-viewid], [data-roomid]").forEach((e=>{e&&(e.setAttribute("data-interactive","true"),e.addEventListener("click",handleRoomButtonClick))})),isScreenLocked=!0}catch(e){console.error("Error locking screen:",e)}}function unlockScreen(){if(WALK.getViewer())try{window._lockInterval&&(clearInterval(window._lockInterval),window._lockInterval=null),removeMovementBlocker(),document.removeEventListener("keydown",blockNavigationKeys);document.querySelectorAll(".view-menu a, [data-viewid], [data-roomid]").forEach((e=>{e&&(e.removeAttribute("data-interactive"),e.removeEventListener("click",handleRoomButtonClick))}));const e=document.getElementById("lock-button");e&&e.classList.remove("locked"),isScreenLocked=!1,lockedPosition=null,lockedRotation=null,window._isAllowedTransition=!1}catch(e){console.error("Error unlocking screen:",e)}}function handleRoomButtonClick(){window._isAllowedTransition=!0}function blockNavigationKeys(e){if(!isScreenLocked)return;return["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d","W","A","S","D"," "].includes(e.key)?(e.preventDefault(),e.stopPropagation(),!1):void 0}function setupMovementBlocker(){const e=document.querySelector("canvas");function t(t){let o=t.target,n=!1;for(;o&&o!==document;){if(o.hasAttribute("data-interactive")||o.classList.contains("material-picker")||"picker"===o.id||"lock-button"===o.id||o.closest(".view-menu")||o.closest("[data-viewid]")||o.closest("[data-roomid]")||o.hasAttribute("data-sphere")){n=!0;break}o=o.parentNode}return!!n||("mousemove"===t.type||"wheel"===t.type||t.target===e||"CANVAS"===t.target.tagName?(t.stopPropagation(),t.preventDefault(),!1):void 0)}e&&(e.addEventListener("mousedown",t,!0),e.addEventListener("mouseup",t,!0),e.addEventListener("mousemove",t,!0),e.addEventListener("wheel",t,!0),e.addEventListener("click",t,!0),document.addEventListener("mousemove",t,!0),e._blockMovement=t,document._blockMovement=t)}function removeMovementBlocker(){const e=document.querySelector("canvas");e&&e._blockMovement&&(e.removeEventListener("mousedown",e._blockMovement,!0),e.removeEventListener("mouseup",e._blockMovement,!0),e.removeEventListener("mousemove",e._blockMovement,!0),e.removeEventListener("wheel",e._blockMovement,!0),e.removeEventListener("click",e._blockMovement,!0),document._blockMovement&&(document.removeEventListener("mousemove",document._blockMovement,!0),document._blockMovement=null),e._blockMovement=null)}function toggleScreenLock(){isScreenLocked?unlockScreen():lockScreen()}function setupCanvasEventHandlers(){const e=document.querySelector("canvas");if(!e)return void console.error("Canvas element not found");function t(e){const t=e.target;return!!(t.closest(".view-menu")||t.closest("[data-view]")||t.closest("[data-viewid]")||t.closest("[data-roomid]")||t.closest(".material-picker")||t.closest("#picker")||t.closest("#lock-container"))||(e.preventDefault(),e.stopPropagation(),!1)}window._originalPointerEvents=e.style.pointerEvents,e._lockHandlersInstalled=!0,e.addEventListener("mousedown",t,!0),e.addEventListener("mousemove",t,!0),e.addEventListener("mouseup",t,!0),e.addEventListener("wheel",t,!0),e.addEventListener("touchstart",t,!0),e.addEventListener("touchmove",t,!0),e.addEventListener("touchend",t,!0),e._blockNavigation=t;const o=WALK.getViewer();o&&o.navigation&&o.navigation.enabled,document.querySelectorAll(".view-menu, [data-view], [data-viewid], [data-roomid], .material-picker, #picker, #lock-container").forEach((e=>{e&&(e.style.zIndex="2000",e.style.pointerEvents="auto")}))}function removeCanvasEventHandlers(){const e=document.querySelector("canvas");if(!e||!e._lockHandlersInstalled)return;e._blockNavigation&&(e.removeEventListener("mousedown",e._blockNavigation,!0),e.removeEventListener("mousemove",e._blockNavigation,!0),e.removeEventListener("mouseup",e._blockNavigation,!0),e.removeEventListener("wheel",e._blockNavigation,!0),e.removeEventListener("touchstart",e._blockNavigation,!0),e.removeEventListener("touchmove",e._blockNavigation,!0),e.removeEventListener("touchend",e._blockNavigation,!0)),e.style.pointerEvents=window._originalPointerEvents||"",e._lockHandlersInstalled=!1;const t=WALK.getViewer();t&&t.navigation&&(void 0!==t.navigation.enabled&&(t.navigation.enabled=!0),t.navigation.domElement&&(t.navigation.domElement.style.pointerEvents="")),document.querySelectorAll(".view-menu, [data-view], [data-viewid], [data-roomid], .material-picker, #picker, #lock-container").forEach((e=>{e&&(e.style.zIndex="",e.style.pointerEvents="")}))}function loadMaterialsConfig(){fetch("https://anupdg.github.io/oneloom/materials-config.json").then((e=>{if(!e.ok)throw new Error("Failed to load materials config");return e.json()})).then((e=>{materialsConfig=e,loadTexturesForMaterial(MATERIAL_NAME)})).catch((e=>{console.error("Error loading materials config:",e)}))}function loadTexturesForMaterial(e){if(!materialsConfig||!materialsConfig.materials[e])return void console.error("Material not found:",e);const t=document.getElementById("texture-container");t.innerHTML="";materialsConfig.materials[e].textures.forEach((o=>{const n=document.createElement("div");let i;n.className="texture-item",n.dataset.id=o.id,"video"===o.type?(i=document.createElement("video"),i.autoplay=!0,i.muted=!0,i.loop=!0):i=document.createElement("img"),i.id=o.id,i.src=o.url,i.crossOrigin="anonymous";const a=document.createElement("div");a.className="texture-label",a.textContent=o.id,n.appendChild(i),n.appendChild(a),t.appendChild(n),n.addEventListener("click",(function(){document.querySelectorAll(".texture-item").forEach((e=>{e.classList.remove("selected")})),n.classList.add("selected"),applyTextureToMaterial(e,o)}))}))}function applyTextureToMaterial(e,t){const o=WALK.getViewer();if(!o)return void console.error("Viewer not available");const n=document.getElementById(t.id);if(!n)return void console.error("Texture element not found:",t.id);let i=textureCache[t.id];i||(i="video"===t.type?o.createTextureFromHtmlVideo(n):o.createTextureFromHtmlImage(n),textureCache[t.id]=i);const a=o.findMaterial(e);a?(a.baseColorTexture=i,window.selection={material:e,texture:t.id},sendSelectionUpdate(),o.requestFrame()):console.error("Material not found:",e)}function sendSelectionUpdate(){window.parent.postMessage({type:"SELECTION_UPDATE",payload:{selection:window.selection}},"*")}function initViewer(){const e=WALK.getViewer();e?(e.setMaterialEditable(MATERIAL_NAME),loadMaterialsConfig(),"function"==typeof e.onApiUserStateChanged&&e.onApiUserStateChanged((function(e,t){if(e.startsWith("MaterialPicker:")){const o=e.replace("MaterialPicker:","");window.selection={material:o,texture:t},sendSelectionUpdate()}})),window.addEventListener("message",(function(e){e.data&&"GET_SELECTION"===e.data.type&&sendSelectionUpdate()}))):setTimeout(initViewer,500)}document.addEventListener("DOMContentLoaded",(function(){createPickerUI(),createLockButton(),initViewer()}));
