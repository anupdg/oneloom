window.selection={material:null,texture:null};let materialsConfig=null;const textureCache={},MATERIAL_NAME="ceiling";let isScreenLocked=!1,lockedPosition=null,lockedRotation=null;function createPickerUI(){const e=document.createElement("div");e.id="picker",e.className="collapsed",e.style.position="absolute",e.style.top="30%",e.style.left="20px",e.style.zIndex="1000";const t=document.createElement("button");t.id="toggle-picker",t.textContent="→";const o=document.createElement("div");o.id="picker-content";const n=document.createElement("h3");n.textContent="Textures";const i=document.createElement("div");i.className="texture-container",i.id="texture-container",o.appendChild(n),o.appendChild(i),e.appendChild(t),e.appendChild(o),document.body.appendChild(e),t.addEventListener("click",(function(){e.classList.toggle("collapsed"),e.classList.contains("collapsed")?this.textContent="→":this.textContent="←"}))}function createLockButton(){const e=document.createElement("div");e.id="lock-container",e.style.position="absolute",e.style.top="50%",e.style.left="20px",e.style.transform="translateY(-50%)",e.style.zIndex="1000";const t=document.createElement("button");t.id="lock-button",t.className="lock-button",t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>',t.addEventListener("click",toggleScreenLock),e.appendChild(t),document.body.appendChild(e)}function toggleScreenLock(){isScreenLocked?unlockScreen():lockScreen()}function lockScreen(){const e=WALK.getViewer();if(e)try{createMovementBlockerOverlay();const t=e.getCameraPosition(),o=e.getCameraRotation();lockedPosition={x:t.x,y:t.y,z:t.z,clone:function(){return{x:this.x,y:this.y,z:this.z}},distanceTo:function(e){const t=this.x-e.x,o=this.y-e.y,n=this.z-e.z;return Math.sqrt(t*t+o*o+n*n)}},lockedRotation={yaw:o.yaw,pitch:o.pitch,roll:o.roll,clone:function(){return{yaw:this.yaw,pitch:this.pitch,roll:this.roll}}},console.log("Locking camera at exact position:",{position:{x:lockedPosition.x,y:lockedPosition.y,z:lockedPosition.z},rotation:{yaw:lockedRotation.yaw,pitch:lockedRotation.pitch,roll:lockedRotation.roll}});let n={};try{"function"==typeof WALK.View?(n=new WALK.View,n.position=lockedPosition,n.rotation=lockedRotation):n={position:lockedPosition,rotation:lockedRotation},console.log("Created precise view at current position")}catch(e){console.error("Error creating View object:",e),n={position:lockedPosition,rotation:lockedRotation}}window._lockedCustomView=n,e.canvas&&(e.canvas.style.pointerEvents="none"),window._lockInterval&&clearInterval(window._lockInterval),window._lockInterval=setInterval((()=>{try{"function"==typeof e.switchToView&&e.switchToView(window._lockedCustomView,0)}catch(e){console.error("Error in position enforcement:",e)}}),50);document.getElementById("lock-button").classList.add("locked"),isScreenLocked=!0,console.log("Screen locked at exact current position")}catch(e){console.error("Error locking screen:",e)}else console.error("Viewer not available")}function unlockScreen(){const e=WALK.getViewer();if(e)try{window._lockInterval&&(clearInterval(window._lockInterval),window._lockInterval=null,console.log("Stopped position enforcement")),e.navigation&&void 0!==e.navigation.enabled&&(e.navigation.enabled=!0,console.log("Re-enabled navigation")),removeMovementBlockerOverlay();document.getElementById("lock-button").classList.remove("locked"),isScreenLocked=!1,lockedPosition=null,lockedRotation=null,console.log("Screen unlocked")}catch(e){console.error("Error unlocking screen:",e)}else console.error("Viewer not available")}function createMovementBlockerOverlay(){removeMovementBlockerOverlay();const e=document.createElement("div");function t(e){return e.preventDefault(),e.stopPropagation(),!1}e.id="movement-blocker-overlay",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="transparent",e.style.zIndex="999",e.style.cursor="not-allowed",e.addEventListener("mousedown",t,!0),e.addEventListener("mousemove",t,!0),e.addEventListener("mouseup",t,!0),e.addEventListener("wheel",t,!0),e.addEventListener("touchstart",t,!0),e.addEventListener("touchmove",t,!0),e.addEventListener("touchend",t,!0);const o=document.querySelector("canvas");if(o&&o.parentNode){o.parentNode.appendChild(e),console.log("Created movement blocker overlay");const t=document.getElementById("lock-container");t&&(t.style.zIndex="1001")}else console.error("Could not find canvas element to block")}function removeMovementBlockerOverlay(){const e=document.getElementById("movement-blocker-overlay");e&&(e.parentNode.removeChild(e),console.log("Removed movement blocker overlay"))}function loadMaterialsConfig(){fetch("https://anupdg.github.io/oneloom/materials-config.json").then((e=>{if(!e.ok)throw new Error("Failed to load materials config");return e.json()})).then((e=>{materialsConfig=e,loadTexturesForMaterial(MATERIAL_NAME)})).catch((e=>{console.error("Error loading materials config:",e)}))}function loadTexturesForMaterial(e){if(!materialsConfig||!materialsConfig.materials[e])return void console.error("Material not found:",e);const t=document.getElementById("texture-container");t.innerHTML="";materialsConfig.materials[e].textures.forEach((o=>{const n=document.createElement("div");let i;n.className="texture-item",n.dataset.id=o.id,"video"===o.type?(i=document.createElement("video"),i.autoplay=!0,i.muted=!0,i.loop=!0):i=document.createElement("img"),i.id=o.id,i.src=o.url,i.crossOrigin="anonymous";const l=document.createElement("div");l.className="texture-label",l.textContent=o.id,n.appendChild(i),n.appendChild(l),t.appendChild(n),n.addEventListener("click",(function(){document.querySelectorAll(".texture-item").forEach((e=>{e.classList.remove("selected")})),n.classList.add("selected"),applyTextureToMaterial(e,o)}))}))}function applyTextureToMaterial(e,t){const o=WALK.getViewer();if(!o)return void console.error("Viewer not available");const n=document.getElementById(t.id);if(!n)return void console.error("Texture element not found:",t.id);let i=textureCache[t.id];i||(i="video"===t.type?o.createTextureFromHtmlVideo(n):o.createTextureFromHtmlImage(n),textureCache[t.id]=i);const l=o.findMaterial(e);l?(l.baseColorTexture=i,window.selection={material:e,texture:t.id},window.parent.postMessage({type:"SELECTION_UPDATE",payload:{selection:window.selection}},"*"),o.requestFrame()):console.error("Material not found:",e)}function initViewer(){const e=WALK.getViewer();e?(console.log("Shapespark viewer initialized"),e.setMaterialEditable(MATERIAL_NAME),loadMaterialsConfig(),window.addEventListener("message",(function(e){e.data&&"GET_SELECTION"===e.data.type&&window.parent.postMessage({type:"SELECTION_UPDATE",payload:{selection:window.selection}},"*")}))):setTimeout(initViewer,500)}document.addEventListener("DOMContentLoaded",(function(){createPickerUI(),createLockButton(),initViewer()}));
